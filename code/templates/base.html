{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Moni</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ê³µí†µ CSS -->
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}?v=20260108_12">

    {# í˜ì´ì§€ë³„ ì¶”ê°€ CSS #}
    {% block extra_css %}{% endblock %}

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ë°°ê²½ + ì¤‘ì•™ ì •ë ¬) -->
    <style>
        .loader-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
        }
    </style>
</head>
<body>

<div class="dashboard-layout">
    <div class="main-area">

        <!-- ===== ê³µí†µ ìƒë‹¨ë°” ===== -->
        <header class="topbar">
            <div class="topbar-left">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">
                        <img src="{% static 'img/profile.png' %}" alt="personal logo">
                    </div>
                    <div class="sidebar-logo-text">
                        {% if request.user.is_authenticated %}
                            {{ request.user.first_name }} ë‹˜
                        {% endif %}
                    </div>
                </div>

                <nav class="topbar-nav">
                    <a href="{% url 'home' %}"
                       class="topbar-nav-item {% if page == 'home' %}active{% endif %}">
                        HOME
                    </a>
                    <a href="{% url 'spending_analysis' %}"
                       class="topbar-nav-item {% if page == 'spending_analysis' %}active{% endif %}">
                        ì†Œë¹„íŒ¨í„´ ë¶„ì„
                    </a>
                    <a href="{% url 'spending_history' %}"
                       class="topbar-nav-item {% if page == 'spending_history' %}active{% endif %}">
                        ì†Œë¹„ë‚´ì—­
                    </a>
                    <a href="{% url 'mypage' %}"
                       class="topbar-nav-item {% if page == 'mypage' %}active{% endif %}">
                        ë‚´ì •ë³´
                    </a>
                </nav>
            </div>

            <div class="topbar-right">
                <!-- ğŸ” ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ (ID: refreshBtn) -->
                <div class="refresh-btn" id="refreshBtn" data-no-loader="true">
                    <img src="{% static 'img/refresh.png' %}" alt="refresh">
                </div>

                <!-- ğŸ”” ì•Œë¦¼ ì¢… -->
                <div class="user-avatar" id="notificationBell" data-no-loader="true" data-notifications-latest-id="{{ notifications_latest_id|default:0 }}">
                    <img src="{% static 'img/notification.png' %}" alt="notification">
                    <span class="notification-indicator" id="notificationIndicator" aria-hidden="true"></span>
                </div>
            </div>
        </header>

        <!-- ===== ê° í˜ì´ì§€ ë³¸ë¬¸ ì˜ì—­ ===== -->
        {% block content %}{% endblock %}

    </div>
</div>

<!-- ===== ê³µí†µ ì•Œë¦¼ ì˜¤ë²„ë ˆì´ ===== -->
<div class="notification-overlay" id="notificationOverlay">
    <div class="notification-panel">
        <div class="notification-header">
            <span>Notification</span>
            <button class="notification-close" id="notificationCloseBtn">âœ•</button>
        </div>

        {% for noti in notifications|slice:":5" %}
        <div class="notification-item">
            <div class="noti-dot orange"></div>
            <div class="noti-content">
                <div class="noti-title">
                    {{ noti.notification_detail }}
                </div>

                <!-- sub ë©”ì‹œì§€ ì—†ìœ¼ë©´ ìˆ¨ê¸°ê±°ë‚˜ ê³ ì • -->
                <div class="noti-sub">ì•Œë¦¼</div>

                <div class="noti-time">
                    {{ noti.notification_time|date:"h:i A" }}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="notification-item">
            <div class="noti-content">
                ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>
        {% endfor %}

    </div>
</div>


<!-- ===== ìºë¦­í„° ë¡œë”© ì˜¤ë²„ë ˆì´ (ë™ê·¸ë€ ë²„ì „) ===== -->
<div id="moniLoader" class="loader-overlay">
    <div class="loader-circle">
        <p class="loader-text">ë¡œë”©ì¤‘ <span class="loader-dots">...</span></p>

        <img src="{% static 'img/type_aggressive.png' %}"
             alt="ê³µê²©í˜•"
             class="loader-char char-top">

        <img src="{% static 'img/type_safe.png' %}"
             alt="ì•ˆì „í˜•"
             class="loader-char char-right">

        <img src="{% static 'img/type_yolo.png' %}"
             alt="YOLOí˜•"
             class="loader-char char-bottom-right">

        <img src="{% static 'img/type_goal.png' %}"
             alt="ëª©í‘œë‹¬ì„±í˜•"
             class="loader-char char-left">

        <img src="{% static 'img/type_saving.png' %}"
             alt="ì ˆì•½í˜•"
             class="loader-char char-bottom-left">
    </div>
</div>

<!-- ===== ë§ˆì´ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë²„ë ˆì´ ===== -->
<div id="mydataOverlay" class="mydata-overlay" style="display:none;">
    <div class="mydata-card">
        <button type="button" class="mydata-close" id="mydataCloseBtn">âœ•</button>

        <p class="mydata-title">ë§ˆì´ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ê¹Œìš”?</p>
        <p class="mydata-desc">
            ì€í–‰Â·ì¹´ë“œÂ·í†µì¥ ì •ë³´ë¥¼ ì—°ê²°í•´ì„œ<br>
            Moniê°€ ì†Œë¹„ íŒ¨í„´ì„ ì •í™•í•˜ê²Œ ë¶„ì„í•´ ì¤„ê²Œìš”.
        </p>

        <button type="button" class="mydata-button" id="mydataStartBtn">
            ë§ˆì´ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        </button>
</div>
</div>

<!-- ===== ë§ˆì´ë°ì´í„° ì„¤ë¬¸ ì˜¤ë²„ë ˆì´ ===== -->
<div id="mydataSurveyOverlay" class="survey-overlay" style="display:none;">
    <div class="survey-card" role="dialog" aria-modal="true" aria-labelledby="surveyTitle">
        <div class="survey-header">
            <div class="survey-title" id="surveyTitle">
                {% if request.user.is_authenticated %}
                    {{ request.user.first_name }} ë‹˜ ì§€ê¸ˆê¹Œì§€ ì‚¬ìš©í•´ë³¸ ê¸ˆìœµ ìƒí’ˆì„ ì•Œë ¤ì£¼ì„¸ìš”.
                {% else %}
                    ì‚¬ìš©ìë‹˜ ì§€ê¸ˆê¹Œì§€ ì‚¬ìš©í•´ë³¸ ê¸ˆìœµ ìƒí’ˆì„ ì•Œë ¤ì£¼ì„¸ìš”.
                {% endif %}
            </div>
        </div>

        <form id="mydataSurveyForm" class="survey-body">
            <section class="survey-step is-active" data-step="1">
                <div class="survey-q">
                    <label class="survey-option"><input type="checkbox" name="q1" value="deposit"> ì˜ˆê¸ˆ</label>
                    <label class="survey-option"><input type="checkbox" name="q1" value="saving"> ì ê¸ˆ</label>
                    <label class="survey-option"><input type="checkbox" name="q1" value="cma"> CMA , ISA  </label>
                    <label class="survey-option"><input type="checkbox" name="q1" value="stock"> íŒŒí‚¹í†µì¥</label>
                    <label class="survey-option"><input type="checkbox" name="q1" value="stock"> ì—†ìŒ</label>
                </div>
            </section>
        </form>
        <div class="survey-footer">
            <button type="button" class="survey-btn" id="surveySaveBtn">í™•ì¸</button>
        </div>
    </div>
</div>

<div id="toastArea" class="toast-area"></div>

<script>
/* ===== ë¡œë”©ì°½ show/hide ===== */
function showMoniLoader() {
    var el = document.getElementById("moniLoader");
    if (el) el.style.display = "flex";
}
function hideMoniLoader() {
    var el = document.getElementById("moniLoader");
    if (el) el.style.display = "none";
}

/* ===== ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ ===== */
document.addEventListener("DOMContentLoaded", function () {
    hideMoniLoader();

    /* --- 1) ë§í¬ í´ë¦­ ì‹œ ë¡œë”© í‘œì‹œ --- */
    document.querySelectorAll("a[href]").forEach(function (link) {
        link.addEventListener("click", function () {
            const href     = link.getAttribute("href");
            const target   = link.getAttribute("target");
            const noLoader = link.dataset.noLoader === "true";

            if (!href ||
                href.startsWith("#") ||
                href.startsWith("javascript:") ||
                target === "_blank" ||
                noLoader) {
                return;
            }
            showMoniLoader();
        });
    });

    /* --- 2) ì•Œë¦¼ì°½  --- */
    const bellBtn  = document.getElementById("notificationBell");
    const overlay  = document.getElementById("notificationOverlay");
    const closeBtn = document.getElementById("notificationCloseBtn");
    const indicator = document.getElementById("notificationIndicator");
    const latestNotificationId = Number((bellBtn && bellBtn.dataset && bellBtn.dataset.notificationsLatestId) || 0);

    function refreshUnreadIndicator() {
        if (!indicator) return;
        const lastSeenId = Number(localStorage.getItem("notifications_last_seen_id") || 0);
        indicator.classList.toggle("show", latestNotificationId > lastSeenId);
    }

    if (bellBtn && overlay) {
        bellBtn.addEventListener("click", function () {
            overlay.style.display = "flex";
            bellBtn.classList.add("notification-bell-active");
            if (latestNotificationId > 0) {
                localStorage.setItem("notifications_last_seen_id", String(latestNotificationId));
            }
            refreshUnreadIndicator();
        });
    }

    if (closeBtn && overlay && bellBtn) {
        closeBtn.addEventListener("click", function () {
            overlay.style.display = "none";
            bellBtn.classList.remove("notification-bell-active");
        });
    }

    if (overlay && bellBtn) {
        overlay.addEventListener("click", function (e) {
            if (e.target === overlay) {
                overlay.style.display = "none";
                bellBtn.classList.remove("notification-bell-active");
            }
        });
    }

    refreshUnreadIndicator();

    /* --- 3) ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ --- */
    const refreshBtn = document.getElementById("refreshBtn");

    if (refreshBtn) {
        refreshBtn.addEventListener("click", function () {
            showMoniLoader();
            setTimeout(function () {
                location.reload();
            }, 120);
        });
    }

    /* --- 4) ë§ˆì´ë°ì´í„° íŒì—…  --- */
    const mydataOverlay = document.getElementById("mydataOverlay");
    const mydataShowFlag = "{{ show_mydata_popup|yesno:'True,False' }}";
    const mydataSurveyOverlay = document.getElementById("mydataSurveyOverlay");
    const surveySaveBtn = document.getElementById("surveySaveBtn");
    const surveyForm = document.getElementById("mydataSurveyForm");

    if (mydataShowFlag === "True") {
        if (mydataSurveyOverlay) {
            mydataSurveyOverlay.style.display = "flex";
        } else if (mydataOverlay) {
            mydataOverlay.style.display = "flex";
        }
    }

    const mydataStartBtn = document.getElementById("mydataStartBtn");
    const mydataCloseBtn = document.getElementById("mydataCloseBtn");

    if (mydataStartBtn && mydataOverlay) {
        mydataStartBtn.addEventListener("click", function () {
            localStorage.setItem("forceSpendingLoading", "1");
            showMoniLoader();
            window.location.href = "{% url 'mydata_start' %}";
        });
    }

    if (mydataCloseBtn && mydataOverlay) {
        mydataCloseBtn.addEventListener("click", function () {
            mydataOverlay.style.display = "none";
        });

        mydataOverlay.addEventListener("click", function (e) {
            if (e.target === mydataOverlay) {
                mydataOverlay.style.display = "none";
            }
        });
    }

    /* --- 5) ë§ˆì´ë°ì´í„° ì„¤ë¬¸ íŒì—… --- */
    if (mydataSurveyOverlay && surveySaveBtn) {
        function closeSurvey() {
            mydataSurveyOverlay.style.display = "none";
        }

        function openMydata() {
            if (mydataOverlay) mydataOverlay.style.display = "flex";
        }

        function currentAnswers() {
            if (!surveyForm) return {};
            const data = new FormData(surveyForm);
            return {
                q1: data.getAll("q1"),
            };
        }

        function finishSurvey() {
            try {
                localStorage.setItem("mydataSurveyAnswers", JSON.stringify(currentAnswers()));
            } catch (e) {}
            closeSurvey();
            openMydata();
        }

        mydataSurveyOverlay.addEventListener("click", function (e) {
            if (e.target === mydataSurveyOverlay) {
                closeSurvey();
                openMydata();
            }
        });

        surveySaveBtn.addEventListener("click", finishSurvey);
    }
});

/* ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ë“±ìœ¼ë¡œ ëŒì•„ì™”ì„ ë•Œ ë¡œë”© ìˆ¨ê¸°ê¸° */
window.addEventListener("pageshow", function () {
    hideMoniLoader();
});

/* notification push */
document.addEventListener("DOMContentLoaded", function () {
  const toastArea = document.getElementById("toastArea");
  if (!toastArea) {
    return;
  }

  const renderedLatestId = Number("{{ notifications.0.id|default:'0' }}") || 0;
  const storedLastIdRaw = localStorage.getItem("lastNotificationId");
  let lastId = storedLastIdRaw !== null ? Number(storedLastIdRaw || "0") : renderedLatestId;
  if (storedLastIdRaw === null) {
    localStorage.setItem("lastNotificationId", String(lastId));
  }

  const POLL_MS = 3000;   // 2ì´ˆ
  const TOAST_MS = 5000;  // 5ì´ˆ í›„ ìë™ ë‹«í˜

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function showToast(item){
    const el = document.createElement("div");
    el.className = "toast";
    el.innerHTML = `
      <div class="toast-head">
        <div class="toast-title">Moniì˜ ìƒˆ ì•Œë¦¼</div>
        <button class="toast-close" type="button">âœ•</button>
      </div>
      <div class="toast-body">${escapeHtml(item.notification_detail)}</div>
      <div class="toast-time">${escapeHtml(item.notification_time)}</div>
    `;

    el.querySelector(".toast-close").addEventListener("click", () => el.remove());
    toastArea.appendChild(el);

    setTimeout(() => {
      if (el && el.parentNode) el.remove();
    }, TOAST_MS);
  }

  async function poll(){
    try{
      const res = await fetch(`{% url 'notifications_push' %}?last_id=${lastId}`, {
        headers: {"X-Requested-With":"XMLHttpRequest"},
        cache: "no-store",
      });
      if (!res.ok) return;

      const data = await res.json();
      if (!data.ok) return;

      const items = Array.isArray(data.items) ? data.items : [];
      if (!items.length) return;

      // âœ… ì˜¤ë˜ëœ ê²ƒë¶€í„° ë³´ì—¬ì£¼ê¸°(ì„ íƒ)
      items.sort((a,b) => (a.id||0) - (b.id||0));


      items.forEach(showToast);


      const maxId = Math.max(...items.map(x => Number(x.id || 0)), lastId);
      lastId = maxId;

      localStorage.setItem("lastNotificationId", String(lastId));
    }catch(e){
      // silent
    }
  }

  poll();
  setInterval(poll, POLL_MS);
});


</script>

{# í˜ì´ì§€ë³„ ì¶”ê°€ JS #}
{% block extra_js %}{% endblock %}

</body>
</html>
