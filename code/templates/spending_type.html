{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- ===== 메인 내용 ===== -->
<main class="main-content spending-detail-main">

    <!-- 가운데 폰 화면처럼 보이는 카드 -->
    <section class="spending-detail-layout">
        <div class="spending-detail-card">


            {% if is_spending_type_loading %}
                <div class="spending-loading-wrapper" style="margin: 60px 0;">
                    <div class="moni-loading-card">
                        <div class="moni-loading-circle">
                            <div class="moni-loading-text">
                                소비 유형 분석 중<span class="loader-dots"></span>
                            </div>
                        </div>

                        <div class="moni-loading-character moni-pos-top">
                            <img src="{% static 'img/type_aggressive.png' %}" alt="진격의투자형">
                        </div>
                        <div class="moni-loading-character moni-pos-right">
                            <img src="{% static 'img/type_safe.png' %}" alt="안정형">
                        </div>
                        <div class="moni-loading-character moni-pos-bottom-right">
                            <img src="{% static 'img/type_yolo.png' %}" alt="YOLO형">
                        </div>
                        <div class="moni-loading-character moni-pos-bottom-left">
                            <img src="{% static 'img/type_saving.png' %}" alt="절약형">
                        </div>
                        <div class="moni-loading-character moni-pos-bottom">
                            <img src="{% static 'img/type_goal.png' %}" alt="목표요정형">
                        </div>
                    </div>

                    <div class="spending-loading-caption">
                        당신의 소비유형을 분석하고 있어요.
                        <br>조금만 기다려 주세요!
                    </div>
                </div>

            {# =========================
               2) 결과(상세) 화면
               ========================= #}
            {% else %}


            <!-- 상단 텍스트 -->
            <header class="spending-detail-header">
                {% if not request.GET.preview %}
                    <p class="spending-detail-subtitle">{{ request.user.first_name }}님의 소비 유형은</p>
                    <div style="height: 10px;"></div>
                {% endif %}

                <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 20px;">
                    <h1 class="spending-detail-title" style="margin-bottom: 0;">
                        {% if display_type %}{{ display_type.type_name }}{% else %}아직 분석된 소비 유형이 없습니다{% endif %}
                    </h1>

                    {% if display_type %}
                    <div class="custom-speech-bubble">
                        {% if display_type.type_id == 1 %}
                            <b>적금으로 모은 돈을 예금으로 전환하면 더 안정적인 자산 관리가 가능해요.
                        {% elif display_type.type_id == 2 %}
                            <b>현재의 저축 흐름을 유지하면서, 목적별로 자산을 나눠 관리하면 더 좋아요.
                        {% elif display_type.type_id == 3 %}
                            <b>현재의 저축 흐름에는 파킹통장을 활용한 관리가 잘 어울려요.
                        {% elif display_type.type_id == 4 %}
                            <b>짧은 기간 저축부터 성공 경험을 만들어보는 걸 추천해요.
                        {% elif display_type.type_id == 5 %}
                            <b>투자 기회를 대비해, 단기 자금은 CMA로 분리 관리하는 것이 좋아요.
                        {% else %}
                            유형별 저축팁을 전해드릴게요.
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <div style="height: 2px;"></div>
            </header>


            <!-- 초록 박스 메인 영역 -->
            <section class="spending-detail-highlight">
                <div class="highlight-text">

                    <p class="highlight-quote">
                        {% if display_type %}
                            {{ display_type.explanation }}
                        {% else %}
                            소비 데이터를 불러오면 소비 유형을 알려드릴게요.
                        {% endif %}
                    </p>

                    <div style="height: 3px;"></div>

                    <p class="highlight-desc">
                        {% if explanation_sentences %}
                            {% for sentence in explanation_sentences %}
                                {{ sentence }}{% if not forloop.last %}.<br>{% endif %}
                                {% if forloop.last %}.{% endif %}
                            {% endfor %}
                        {% else %}
                            소비 데이터를 쌓으면 나만의 소비 유형을 알려줄게요.
                        {% endif %}
                    </p>

                    <div style="height: 25px;"></div>

                    {% comment %} <div class="highlight-products">
                        <p class="highlight-products-title">{{ request.user.first_name }} 님에게 맞는 금융 상품 보러가기</p>
                        <div style="height: 20px;"></div>
                        <div class="highlight-products-list">
                            <button href = "{{ user_type.product_url }}" class="highlight-product-chip" type="button">
                                <span class="chip-icon"></span>
                                {{user_type.product}} 보러가기
                            </button>
                            
                        </div>
                    </div> {% endcomment %}
                </div>

                <!-- 오른쪽 캐릭터 -->
                <div class="highlight-illust">
                    <div class="highlight-illust-circle">
                        {% if display_type %}
                            {% if display_type.type_id == 1 %}
                                <img src="{% static 'img/type_saving.png' %}" alt="절약형 캐릭터">
                            {% elif display_type.type_id == 2 %}
                                <img src="{% static 'img/type_safe.png' %}" alt="안정형 캐릭터">
                            {% elif display_type.type_id == 3 %}
                                <img src="{% static 'img/type_goal.png' %}" alt="목표요정형 캐릭터">
                            {% elif display_type.type_id == 4 %}
                                <img src="{% static 'img/type_yolo.png' %}" alt="YOLO형 캐릭터">
                            {% elif display_type.type_id == 5 %}
                                <img src="{% static 'img/type_aggressive.png' %}" alt="진격의 투자형 캐릭터">
                            {% else %}
                                <img src="{% static 'img/type_goal.png' %}" alt="소비유형 캐릭터">
                            {% endif %}
                        {% else %}
                            <img src="{% static 'img/type_goal.png' %}" alt="소비유형 캐릭터">
                        {% endif %}
                    </div>
                </div>
            </section>

            <!-- 다른 유형 둘러보기 -->
            <section class="spending-detail-others">
                <h2 class="others-title">다른 유형 둘러보기</h2>
                <div style="height: 25px;"></div>

                <div class="others-list">
                    <a class="other-type-item" href="{% url 'spending_type' %}?preview=1">
                        <img src="{% static 'img/type_saving.png' %}" class="other-type-img" alt="절약형">
                        <span class="other-type-label">절약형</span>
                    </a>

                    <a class="other-type-item" href="{% url 'spending_type' %}?preview=2">
                        <img src="{% static 'img/type_safe.png' %}" class="other-type-img" alt="안정형">
                        <span class="other-type-label">안정형</span>
                    </a>

                    <a class="other-type-item" href="{% url 'spending_type' %}?preview=3">
                        <img src="{% static 'img/type_goal.png' %}" class="other-type-img other-type-img-goal" alt="목표요정형">
                        <span class="other-type-label">목표요정형</span>
                    </a>

                    <a class="other-type-item" href="{% url 'spending_type' %}?preview=4">
                        <img src="{% static 'img/type_yolo.png' %}" class="other-type-img" alt="YOLO형">
                        <span class="other-type-label">YOLO형</span>
                    </a>

                    <a class="other-type-item" href="{% url 'spending_type' %}?preview=5">
                        <img src="{% static 'img/type_aggressive.png' %}" class="other-type-img" alt="진격의투자형">
                        <span class="other-type-label">진격의투자형</span>
                    </a>
                </div>

                <div style="height: 25px;"></div>
            </section>

            <!-- 하단: 뒤로가기 -->
            <footer class="spending-detail-footer">
                <a href="{% url 'home' %}" class="spending-back-link">← 대시보드로 돌아가기</a>
            </footer>

            {% endif %}
        </div>
    </section>

</main>

<style>
.custom-speech-bubble {
    position: relative;
    /* 기존 bubble 디자인 적용 */
    background: #D9F99D;
    color: #111827;
    border: 1px solid rgba(20, 83, 45, 0.12);
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);

    /* 새로운 모양 적용 */
    border-radius: 20px;
    padding: 14px 18px;
    
    font-size: 0.95rem;
    line-height: 1.5;
    white-space: nowrap; /* 텍스트를 한 줄로 표시 */
    animation: bubble-in 320ms ease-out both;
}

.custom-speech-bubble b {
    color: #111827;
}

/* 새로운 말풍선 꼬리 모양 */
.custom-speech-bubble::before {
    content: "";
    position: absolute;
    top: 50%;
    transform: translateY(-50%);

    /* 꼬리 위치 및 색상 */
    left: -11px; /* 꼬리를 테두리(1px) 바로 뒤에 붙입니다 */
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    border-right: 12px solid #D9F99D; /* 배경색과 동일하게 */
}

/* 꼬리의 테두리 부분 (optional, for detail) */
.custom-speech-bubble::after {
    content: "";
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: -1; /* 꼬리보다 뒤에 위치 */
    
    left: -12px;
    border-top: 11px solid transparent;
    border-bottom: 11px solid transparent;
    border-right: 13px solid rgba(20, 83, 45, 0.12); /* 테두리 색과 동일하게 */
}


/* bubble-in 애니메이션 (dashboard.css에 없을 경우 대비) */
@keyframes bubble-in {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

{% endblock %}
